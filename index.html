<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IRSA - نظام إدارة العقود والفواتير</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary-color: #000000;
            --secondary-color: #FFD700;
            --accent-color: #333333;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --sidebar-width: 280px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* تصميم تسجيل الدخول */
        .login-container {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 450px;
            text-align: center;
            border: 2px solid var(--secondary-color);
        }

        .company-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            color: var(--secondary-color);
        }

        .company-logo i {
            font-size: 40px;
            margin-left: 10px;
        }

        .company-name {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            text-align: right;
        }

        .company-name span {
            display: block;
            font-size: 14px;
            color: var(--accent-color);
            margin-top: 5px;
        }

        .login-title {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 22px;
            font-weight: 600;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: right;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--accent-color);
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--primary-color) 100%);
            transform: translateY(-2px);
        }

        /* زر تسجيل دخول عضو */
        .user-login-link {
            margin-top: 20px;
            text-align: center;
        }

        .user-login-btn {
            width: 100%;
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-login-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        /* مؤشر المستخدم المتصل */
        .user-status {
            display: flex;
            align-items: center;
            margin-top: 10px;
            padding: 8px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 6px;
            border-right: 3px solid var(--secondary-color);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            background: var(--success-color);
            border-radius: 50%;
            margin-left: 8px;
        }

        .status-text {
            font-size: 12px;
            color: var(--success-color);
            font-weight: 500;
        }

        /* تصميم اللوحة الرئيسية */
        .dashboard {
            display: flex;
            min-height: 100vh;
            background: #f5f5f5;
        }

        /* الشريط الجانبي */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--primary-color);
            color: white;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 2px solid var(--secondary-color);
            background: var(--accent-color);
        }

        .sidebar-nav {
            flex: 1;
            padding: 20px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            border-right: 3px solid transparent;
            cursor: pointer;
        }

        .nav-item:hover {
            background: rgba(255, 215, 0, 0.1);
            border-right-color: var(--secondary-color);
        }

        .nav-item.active {
            background: rgba(255, 215, 0, 0.2);
            border-right-color: var(--secondary-color);
            color: var(--secondary-color);
        }

        .nav-item i {
            margin-left: 10px;
            font-size: 18px;
        }

        .nav-item span {
            font-weight: 500;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid #444;
        }

        .user-menu {
            position: relative;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            color: var(--primary-color);
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: var(--secondary-color);
        }

        .user-email {
            font-size: 12px;
            color: #ccc;
        }

        .user-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: var(--accent-color);
            border: 1px solid #444;
            border-radius: 8px;
            display: none;
            z-index: 1000;
        }

        .user-dropdown.show {
            display: block;
        }

        .user-dropdown a {
            display: block;
            padding: 10px 15px;
            color: white;
            text-decoration: none;
            transition: background 0.3s ease;
            cursor: pointer;
        }

        .user-dropdown a:hover {
            background: rgba(255, 215, 0, 0.2);
            color: var(--secondary-color);
        }

        .user-dropdown a i {
            margin-left: 8px;
        }

        /* المحتوى الرئيسي */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .content-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-right: 4px solid var(--secondary-color);
        }

        .content-header h1 {
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .content-header p {
            color: var(--accent-color);
        }

        .header-actions {
            margin-top: 15px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--primary-color) 100%);
            transform: translateY(-2px);
        }

        /* إحصائيات */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            border-right: 4px solid var(--secondary-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            background: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            color: var(--primary-color);
            font-size: 24px;
        }

        .stat-info h3 {
            font-size: 28px;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-info p {
            color: var(--accent-color);
        }

        /* الإجراءات السريعة */
        .quick-actions {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .quick-actions h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .action-btn {
            background: white;
            border: 2px solid var(--secondary-color);
            padding: 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .action-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        .action-btn i {
            font-size: 24px;
            color: var(--secondary-color);
            margin-bottom: 10px;
            display: block;
        }

        .action-btn:hover i {
            color: var(--primary-color);
        }

        .action-btn span {
            color: var(--primary-color);
            font-weight: 500;
        }

        /* الجداول */
        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* الأزرار في الجداول */
        .btn-sm {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin: 0 2px;
        }

        .btn-edit {
            background: var(--info-color);
            color: white;
        }

        .btn-delete {
            background: var(--danger-color);
            color: white;
        }

        .btn-view {
            background: var(--success-color);
            color: white;
        }

        /* الإعدادات */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .setting-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-right: 4px solid var(--secondary-color);
        }

        .setting-card h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        /* إدارة الصلاحيات */
        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .permission-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .permission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .permission-title {
            font-weight: 600;
            color: var(--primary-color);
        }

        .permission-users {
            margin-top: 10px;
        }

        .user-permission {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .user-permission:last-child {
            border-bottom: none;
        }

        /* المودالات */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary-color);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .modal-header h3 {
            color: white;
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--secondary-color);
        }

        .modal-body {
            padding: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* الإشعارات */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1001;
            max-width: 400px;
            border-right: 4px solid var(--success-color);
        }

        .notification-success {
            border-right-color: var(--success-color);
        }

        .notification-error {
            border-right-color: var(--danger-color);
        }

        .notification-warning {
            border-right-color: var(--warning-color);
        }

        .notification-info {
            border-right-color: var(--info-color);
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .notification-close {
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
        }

        /* الحالات */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
        }

        .status-overdue {
            background: #f8d7da;
            color: #721c24;
        }

        /* معلومات الملف الشخصي */
        .profile-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .profile-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .profile-item:last-child {
            border-bottom: none;
        }

        /* رسالة المنع */
        .access-denied {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid var(--danger-color);
        }

        .access-denied i {
            font-size: 64px;
            color: var(--danger-color);
            margin-bottom: 20px;
        }

        .access-denied h2 {
            color: var(--danger-color);
            margin-bottom: 10px;
        }

        .access-denied p {
            color: var(--accent-color);
            font-size: 16px;
        }

        /* التجاوب مع الشاشات الصغيرة */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            
            .nav-item span {
                display: none;
            }
            
            .company-name {
                display: none;
            }
            
            .user-info {
                display: none;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .actions-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }
    </style>
</head>
<body>
    <!-- شاشة تسجيل الدخول -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="company-logo">
                <i class="fas fa-file-contract"></i>
                <div class="company-name">IRSA<br><span>Trading & Contracting</span></div>
            </div>
            
            <h1 class="login-title">تسجيل الدخول</h1>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="email"><i class="fas fa-envelope"></i> بريد الكتروني</label>
                    <input type="email" id="email" class="form-input" placeholder="أدخل بريدك الإلكتروني" required>
                </div>
                
                <div class="form-group">
                    <label for="password"><i class="fas fa-lock"></i> كلمة السر</label>
                    <input type="password" id="password" class="form-input" placeholder="أدخل كلمة السر" required>
                </div>
                
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> تسجيل دخول
                </button>
            </form>
            
            <!-- زر تسجيل دخول عضو -->
            <div class="user-login-link">
                <button type="button" class="user-login-btn" onclick="contractSystem.showMemberLoginModal()">
                    <i class="fas fa-user"></i> تسجيل دخول عضو
                </button>
            </div>
        </div>
    </div>

    <!-- لوحة التحكم -->
    <div id="dashboard" class="dashboard" style="display: none;">
        <!-- الشريط الجانبي -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="company-logo">
                    <i class="fas fa-file-contract"></i>
                    <div class="company-name">IRSA</div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-item active" onclick="contractSystem.showSection('dashboard')">
                    <i class="fas fa-home"></i>
                    <span>الرئيسية</span>
                </div>
                <div class="nav-item" onclick="contractSystem.showSection('contracts')" id="contractsNav">
                    <i class="fas fa-file-contract"></i>
                    <span>العقود</span>
                </div>
                <div class="nav-item" onclick="contractSystem.showSection('invoices')" id="invoicesNav">
                    <i class="fas fa-receipt"></i>
                    <span>الفواتير</span>
                </div>
                <div class="nav-item" onclick="contractSystem.showSection('users')" id="usersNav" style="display: none;">
                    <i class="fas fa-users"></i>
                    <span>إدارة الأعضاء</span>
                </div>
                <div class="nav-item" onclick="contractSystem.showSection('settings')" id="settingsNav">
                    <i class="fas fa-cog"></i>
                    <span>الإعدادات</span>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-menu">
                    <div class="user-avatar" onclick="contractSystem.toggleUserMenu()">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-info">
                        <div class="user-name" id="userDisplayName">مستخدم</div>
                        <div class="user-email" id="userDisplayEmail">user@example.com</div>
                    </div>
                    <div class="user-dropdown" id="userDropdown">
                        <a onclick="contractSystem.showProfileSection()"><i class="fas fa-user-cog"></i> الملف الشخصي</a>
                        <a onclick="contractSystem.logout()"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- المحتوى الرئيسي -->
        <div class="main-content">
            <!-- شاشة الرئيسية -->
            <div id="dashboardSection" class="content-section active">
                <div class="content-header">
                    <h1>مرحباً بك في نظام إدارة العقود والفواتير</h1>
                    <p>من هنا يمكنك إدارة العقود والفواتير بسهولة</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-file-contract"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="contractsCount">0</h3>
                            <p>إجمالي العقود</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="invoicesCount">0</h3>
                            <p>إجمالي الفواتير</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="usersCount">0</h3>
                            <p>الأعضاء</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-info">
                            <h3>نشط</h3>
                            <p>حالة النظام</p>
                        </div>
                    </div>
                </div>

                <div class="quick-actions">
                    <h2>الإجراءات السريعة</h2>
                    <div class="actions-grid">
                        <button class="action-btn" onclick="contractSystem.showAddContractModal()" id="addContractBtn">
                            <i class="fas fa-plus"></i>
                            <span>إضافة عقد جديد</span>
                        </button>
                        <button class="action-btn" onclick="contractSystem.showAddInvoiceModal()" id="addInvoiceBtn">
                            <i class="fas fa-plus"></i>
                            <span>إضافة فاتورة جديدة</span>
                        </button>
                        <button class="action-btn" onclick="contractSystem.exportData()">
                            <i class="fas fa-download"></i>
                            <span>تصدير البيانات</span>
                        </button>
                        <button class="action-btn" onclick="contractSystem.showAddMemberModal()" id="manageUsersBtn" style="display: none;">
                            <i class="fas fa-user-plus"></i>
                            <span>إضافة عضو جديد</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- شاشة العقود -->
            <div id="contractsSection" class="content-section">
                <div class="content-header">
                    <h1>إدارة العقود</h1>
                    <div class="header-actions">
                        <button class="btn-primary" onclick="contractSystem.showAddContractModal()" id="addContractHeaderBtn">
                            <i class="fas fa-plus"></i> إضافة عقد جديد
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="contractsTable">
                        <thead>
                            <tr>
                                <th>رقم العقد</th>
                                <th>العميل</th>
                                <th>القيمة</th>
                                <th>تاريخ البدء</th>
                                <th>تاريخ الانتهاء</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="contractsTableBody">
                            <!-- سيتم ملؤها ديناميكياً -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- شاشة الفواتير -->
            <div id="invoicesSection" class="content-section">
                <div class="content-header">
                    <h1>إدارة الفواتير</h1>
                    <div class="header-actions">
                        <button class="btn-primary" onclick="contractSystem.showAddInvoiceModal()" id="addInvoiceHeaderBtn">
                            <i class="fas fa-plus"></i> إضافة فاتورة جديدة
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="invoicesTable">
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>العميل</th>
                                <th>المبلغ</th>
                                <th>تاريخ الاصدار</th>
                                <th>تاريخ الاستحقاق</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesTableBody">
                            <!-- سيتم ملؤها ديناميكياً -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- شاشة إدارة الأعضاء -->
            <div id="usersSection" class="content-section">
                <div class="content-header">
                    <h1>إدارة الأعضاء</h1>
                    <div class="header-actions">
                        <button class="btn-primary" onclick="contractSystem.showAddMemberModal()">
                            <i class="fas fa-user-plus"></i> إضافة عضو جديد
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="usersTable">
                        <thead>
                            <tr>
                                <th>الاسم</th>
                                <th>البريد الإلكتروني</th>
                                <th>الدور</th>
                                <th>تاريخ الإنشاء</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- سيتم ملؤها ديناميكياً -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- شاشة الإعدادات -->
            <div id="settingsSection" class="content-section">
                <div class="content-header">
                    <h1>الإعدادات</h1>
                </div>

                <div class="settings-grid">
                    <div class="setting-card">
                        <h3><i class="fas fa-user-shield"></i> إدارة الصلاحيات</h3>
                        <div class="permissions-list" id="permissionsList">
                            <!-- سيتم ملؤها ديناميكياً -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- المودالات -->
    <div id="modalContainer"></div>

    <!-- الإشعارات -->
    <div id="notificationContainer"></div>

    <!-- رابط ملف JavaScript -->
    <script>
        // نظام إدارة العقود والفواتير - النسخة المحسنة
        class ContractManagementSystem {
            constructor() {
                this.currentUser = null;
                this.userData = null;
                this.firebaseManager = new FirebaseManager();
                this.contracts = [];
                this.invoices = [];
                this.members = [];
                this.permissions = {};
                this.isMemberLogin = false;
                this.currentMember = null;
                this.init();
            }

            async init() {
                try {
                    await this.firebaseManager.init();
                    this.setupLogin();
                    this.checkAuthStatus();
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showNotification('خطأ في تهيئة النظام', 'error');
                }
            }

            setupLogin() {
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await this.handleMainAccountLogin();
                    });
                }
            }

            // تسجيل دخول الحساب الرئيسي (المدير)
            async handleMainAccountLogin() {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                if (!email || !password) {
                    this.showNotification('يرجى ملء جميع الحقول', 'error');
                    return;
                }

                this.showNotification('جاري تسجيل الدخول...', 'info');

                const result = await this.firebaseManager.login(email, password);
                
                if (result.success) {
                    await this.loadMainAccountData();
                    this.isMemberLogin = false;
                    this.currentMember = null;
                    this.showDashboard();
                } else {
                    this.showNotification(result.error, 'error');
                }
            }

            // تسجيل دخول العضو
            async handleMemberLogin(email, password) {
                if (!email || !password) {
                    this.showNotification('يرجى ملء جميع الحقول', 'error');
                    return false;
                }

                this.showNotification('جاري تسجيل الدخول...', 'info');

                try {
                    // جلب بيانات الحساب الرئيسي أولاً للتحقق من الأعضاء
                    const mainAccountData = await this.firebaseManager.getMainAccountData();
                    
                    if (!mainAccountData || !mainAccountData.members) {
                        this.showNotification('لا توجد بيانات أعضاء', 'error');
                        return false;
                    }

                    // البحث عن العضو في قائمة الأعضاء
                    const member = mainAccountData.members.find(m => 
                        m.email === email && m.password === password
                    );
                    
                    if (member) {
                        // تسجيل دخول العضو
                        this.currentMember = member;
                        this.currentUser = {
                            email: member.email,
                            name: member.fullName,
                            isMember: true
                        };
                        
                        this.isMemberLogin = true;
                        
                        // تحميل بيانات العضو
                        await this.loadMemberData();
                        this.showDashboard();
                        return true;
                    } else {
                        this.showNotification('البريد الإلكتروني أو كلمة المرور غير صحيحة', 'error');
                        return false;
                    }
                } catch (error) {
                    console.error('Member login error:', error);
                    this.showNotification('خطأ في تسجيل الدخول', 'error');
                    return false;
                }
            }

            async loadMainAccountData() {
                try {
                    const result = await this.firebaseManager.getUserData();
                    
                    if (result.success) {
                        this.userData = result.data;
                        this.contracts = this.userData.contracts || [];
                        this.invoices = this.userData.invoices || [];
                        this.members = this.userData.members || [];
                        this.permissions = this.userData.permissions || {};
                        
                        console.log('📊 Loaded main account data:', {
                            contracts: this.contracts.length,
                            invoices: this.invoices.length,
                            members: this.members.length,
                            source: result.source
                        });
                        
                        // تحديث وقت آخر دخول
                        this.userData.userProfile.lastLogin = new Date().toISOString();
                        await this.saveCurrentData();
                        
                        return true;
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Load main account data error:', error);
                    this.userData = this.firebaseManager.getDefaultUserData();
                    return false;
                }
            }

            async loadMemberData() {
                try {
                    // الأعضاء يشاهدون نفس بيانات الحساب الرئيسي ولكن مع قيود
                    const result = await this.firebaseManager.getMainAccountData();
                    
                    if (result.success) {
                        this.userData = result.data;
                        this.contracts = this.userData.contracts || [];
                        this.invoices = this.userData.invoices || [];
                        this.members = this.userData.members || [];
                        this.permissions = this.userData.permissions || {};
                        
                        console.log('📊 Member loaded data:', {
                            contracts: this.contracts.length,
                            invoices: this.invoices.length,
                            email: this.currentMember.email
                        });
                        
                        return true;
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Load member data error:', error);
                    this.showNotification('خطأ في تحميل البيانات', 'error');
                    return false;
                }
            }

            async saveCurrentData() {
                try {
                    if (!this.userData) {
                        this.userData = this.firebaseManager.getDefaultUserData();
                    }

                    // تحديث البيانات الحالية
                    this.userData.contracts = this.contracts;
                    this.userData.invoices = this.invoices;
                    this.userData.members = this.members;
                    this.userData.permissions = this.permissions;
                    
                    this.userData.userProfile = this.userData.userProfile || {};
                    this.userData.userProfile.name = this.userData.userProfile.name || 
                        this.firebaseManager.currentUser.email.split('@')[0];
                    this.userData.userProfile.email = this.firebaseManager.currentUser.email;
                    this.userData.userProfile.lastActivity = new Date().toISOString();

                    // تحديث البيانات الوصفية
                    this.userData._metadata = this.userData._metadata || {};
                    this.userData._metadata.lastUpdated = new Date().toISOString();
                    this.userData._metadata.userId = this.firebaseManager.currentUser.uid;

                    const result = await this.firebaseManager.saveUserData(this.userData);
                    
                    if (result.success) {
                        console.log('💾 Main account data saved successfully');
                        return true;
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Save current data error:', error);
                    return false;
                }
            }

            showDashboard() {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboard').style.display = 'flex';
                
                if (this.isMemberLogin) {
                    // إذا كان دخول عضو
                    document.getElementById('userDisplayName').textContent = this.currentUser.name;
                    document.getElementById('userDisplayEmail').textContent = this.currentUser.email;
                } else {
                    // إذا كان دخول مدير
                    const userName = this.userData?.userProfile?.name || 
                        this.firebaseManager.currentUser.email.split('@')[0];
                    
                    document.getElementById('userDisplayName').textContent = userName;
                    document.getElementById('userDisplayEmail').textContent = 
                        this.firebaseManager.currentUser.email;
                }
                
                this.showNotification('مرحباً بك في نظام إدارة العقود والفواتير!');
                
                this.loadDashboardData();
                this.updateStats();
                this.updatePermissionsUI();
                this.showUserStatus();
            }

            showUserStatus() {
                const userMenu = document.querySelector('.user-menu');
                // إزالة أي حالة مستخدم سابقة
                const existingStatus = userMenu.querySelector('.user-status');
                if (existingStatus) {
                    existingStatus.remove();
                }
                
                if (this.isMemberLogin) {
                    const statusHTML = `
                        <div class="user-status">
                            <div class="status-indicator"></div>
                            <div class="status-text">عضو متصل</div>
                        </div>
                    `;
                    userMenu.insertAdjacentHTML('beforeend', statusHTML);
                }
            }

            loadDashboardData() {
                this.displayContracts();
                this.displayInvoices();
                if (!this.isMemberLogin) {
                    this.displayMembers();
                }
            }

            updateStats() {
                document.getElementById('contractsCount').textContent = this.contracts.length;
                document.getElementById('invoicesCount').textContent = this.invoices.length;
                document.getElementById('usersCount').textContent = this.members.length;
            }

            updatePermissionsUI() {
                const isMainAccount = !this.isMemberLogin;
                const userPermissions = this.isMemberLogin ? 
                    (this.permissions[this.currentUser.email] || this.getDefaultMemberPermissions()) : 
                    {};
                
                console.log('🔐 Updating permissions:', {
                    isMainAccount: isMainAccount,
                    isMemberLogin: this.isMemberLogin,
                    userEmail: this.isMemberLogin ? this.currentUser.email : this.firebaseManager.currentUser.email,
                    permissions: userPermissions
                });

                // إدارة الأعضاء للحساب الرئيسي فقط
                document.getElementById('usersNav').style.display = isMainAccount ? 'flex' : 'none';
                document.getElementById('manageUsersBtn').style.display = isMainAccount ? 'block' : 'none';

                // تطبيق الصلاحيات على العضو
                if (this.isMemberLogin) {
                    console.log('🔒 Applying restrictions for member');
                    
                    // إخفاء الأقسام الممنوعة
                    if (userPermissions.denyContracts) {
                        document.getElementById('contractsNav').style.display = 'none';
                        document.getElementById('addContractBtn').style.display = 'none';
                        document.getElementById('addContractHeaderBtn').style.display = 'none';
                        console.log('📋 Contracts access denied');
                    }
                    if (userPermissions.denyInvoices) {
                        document.getElementById('invoicesNav').style.display = 'none';
                        document.getElementById('addInvoiceBtn').style.display = 'none';
                        document.getElementById('addInvoiceHeaderBtn').style.display = 'none';
                        console.log('🧾 Invoices access denied');
                    }
                    if (userPermissions.denySettings) {
                        document.getElementById('settingsNav').style.display = 'none';
                        console.log('⚙️ Settings access denied');
                    }

                    // منع التعديل في الجداول
                    if (userPermissions.denyEditContract) {
                        document.querySelectorAll('#contractsTable .btn-edit').forEach(btn => {
                            btn.style.display = 'none';
                        });
                        console.log('✏️ Contract editing denied');
                    }
                    if (userPermissions.denyEditInvoice) {
                        document.querySelectorAll('#invoicesTable .btn-edit').forEach(btn => {
                            btn.style.display = 'none';
                        });
                        console.log('✏️ Invoice editing denied');
                    }
                }
            }

            showSection(sectionName) {
                // التحقق من الصلاحيات أولاً
                if (this.isMemberLogin) {
                    const userPermissions = this.permissions[this.currentUser.email] || this.getDefaultMemberPermissions();
                    
                    if ((sectionName === 'contracts' && userPermissions.denyContracts) ||
                        (sectionName === 'invoices' && userPermissions.denyInvoices) ||
                        (sectionName === 'settings' && userPermissions.denySettings) ||
                        (sectionName === 'users' && this.isMemberLogin)) {
                        
                        this.showAccessDeniedMessage(sectionName);
                        return;
                    }
                }

                // إخفاء جميع الأقسام
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // إخفاء جميع عناصر القائمة
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // إظهار القسم المطلوب
                document.getElementById(sectionName + 'Section').classList.add('active');
                
                // تفعيل عنصر القائمة المناسب
                const navItem = document.querySelector(`.nav-item[onclick="contractSystem.showSection('${sectionName}')"]`);
                if (navItem) {
                    navItem.classList.add('active');
                }
                
                // تحديث البيانات عند عرض القسم
                if (sectionName === 'contracts') {
                    this.displayContracts();
                } else if (sectionName === 'invoices') {
                    this.displayInvoices();
                } else if (sectionName === 'users') {
                    this.displayMembers();
                } else if (sectionName === 'settings') {
                    this.displayPermissions();
                }
            }

            showAccessDeniedMessage(sectionName) {
                const sectionNames = {
                    'contracts': 'صفحة العقود',
                    'invoices': 'صفحة الفواتير', 
                    'settings': 'صفحة الإعدادات',
                    'users': 'صفحة إدارة الأعضاء'
                };
                
                const sectionTitle = sectionNames[sectionName] || 'هذه الصفحة';
                
                const deniedHTML = `
                    <div class="access-denied">
                        <i class="fas fa-ban"></i>
                        <h2>غير مسموح بالوصول</h2>
                        <p>عذراً، ليس لديك صلاحية للوصول إلى ${sectionTitle}</p>
                        <p>يرجى التواصل مع المدير للحصول على الصلاحيات المناسبة</p>
                        <button class="btn-primary" onclick="contractSystem.showSection('dashboard')" style="margin-top: 20px;">
                            <i class="fas fa-home"></i> العودة إلى الرئيسية
                        </button>
                    </div>
                `;
                
                // إخفاء جميع الأقسام
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // إظهار رسالة المنع في القسم المطلوب
                const targetSection = document.getElementById(sectionName + 'Section');
                targetSection.innerHTML = deniedHTML;
                targetSection.classList.add('active');
                
                // إخفاء جميع عناصر القائمة
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                this.showNotification('غير مسموح لك بالوصول إلى هذه الصفحة', 'error');
            }

            toggleUserMenu() {
                const dropdown = document.getElementById('userDropdown');
                dropdown.classList.toggle('show');
            }

            // === نافذة تسجيل دخول العضو ===
            showMemberLoginModal() {
                const modalHTML = `
                    <div class="modal-overlay" id="memberLoginModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3><i class="fas fa-user"></i> تسجيل دخول عضو</h3>
                                <button class="close-btn" onclick="contractSystem.closeModal('memberLoginModal')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <form id="memberLoginForm">
                                    <div class="form-group">
                                        <label>البريد الإلكتروني:</label>
                                        <input type="email" id="memberEmail" class="form-input" required>
                                    </div>
                                    <div class="form-group">
                                        <label>كلمة المرور:</label>
                                        <input type="password" id="memberPassword" class="form-input" required>
                                    </div>
                                    <button type="button" class="btn-primary" style="width: 100%;" onclick="contractSystem.handleMemberLoginForm()">
                                        <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                this.showModal(modalHTML);
            }

            async handleMemberLoginForm() {
                const email = document.getElementById('memberEmail').value;
                const password = document.getElementById('memberPassword').value;
                
                const success = await this.handleMemberLogin(email, password);
                if (success) {
                    this.closeModal('memberLoginModal');
                }
            }

            // === عرض الملف الشخصي ===
            showProfileSection() {
                if (this.isMemberLogin) {
                    this.showMemberProfile();
                } else {
                    this.showMainProfile();
                }
            }

            showMemberProfile() {
                const modalHTML = `
                    <div class="modal-overlay" id="memberProfileModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3><i class="fas fa-user"></i> الملف الشخصي للعضو</h3>
                                <button class="close-btn" onclick="contractSystem.closeModal('memberProfileModal')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="profile-info">
                                    <div class="profile-item">
                                        <strong>الاسم:</strong> ${this.currentUser.name}
                                    </div>
                                    <div class="profile-item">
                                        <strong>البريد الإلكتروني:</strong> ${this.currentUser.email}
                                    </div>
                                    <div class="profile-item">
                                        <strong>الدور:</strong> عضو
                                    </div>
                                    <div class="profile-item">
                                        <strong>الحالة:</strong> نشط
                                    </div>
                                    <div class="profile-item">
                                        <strong>تاريخ الانضمام:</strong> ${this.currentMember.joinDate}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                this.showModal(modalHTML);
            }

            showMainProfile() {
                const modalHTML = `
                    <div class="modal-overlay" id="mainProfileModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3><i class="fas fa-user-cog"></i> الملف الشخصي للمدير</h3>
                                <button class="close-btn" onclick="contractSystem.closeModal('mainProfileModal')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="profile-info">
                                    <div class="profile-item">
                                        <strong>الاسم:</strong> ${this.userData?.userProfile?.name || ''}
                                    </div>
                                    <div class="profile-item">
                                        <strong>البريد الإلكتروني:</strong> ${this.firebaseManager.currentUser.email}
                                    </div>
                                    <div class="profile-item">
                                        <strong>الدور:</strong> مدير النظام
                                    </div>
                                    <div class="profile-item">
                                        <strong>عدد العقود:</strong> ${this.contracts.length}
                                    </div>
                                    <div class="profile-item">
                                        <strong>عدد الفواتير:</strong> ${this.invoices.length}
                                    </div>
                                    <div class="profile-item">
                                        <strong>عدد الأعضاء:</strong> ${this.members.length}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                this.showModal(modalHTML);
            }

            // === إدارة العقود ===
            displayContracts() {
                const tableBody = document.getElementById('contractsTableBody');
                tableBody.innerHTML = '';

                if (this.contracts.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                                <i class="fas fa-file-contract" style="font-size: 48px; margin-bottom: 15px; display: block; color: #ccc;"></i>
                                لا توجد عقود مضافة حتى الآن
                            </td>
                        </tr>
                    `;
                    return;
                }

                this.contracts.forEach((contract, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${contract.contractNumber}</td>
                        <td>${contract.clientName}</td>
                        <td>${contract.amount} ر.ق</td>
                        <td>${contract.startDate}</td>
                        <td>${contract.endDate}</td>
                        <td><span class="status-badge status-${contract.status}">${this.getStatusText(contract.status)}</span></td>
                        <td>
                            <button class="btn-sm btn-edit" onclick="contractSystem.editContract(${index})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-sm btn-delete" onclick="contractSystem.deleteContract(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn-sm btn-view" onclick="contractSystem.viewContract(${index})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            }

            showAddContractModal() {
                const modalHTML = `
                    <div class="modal-overlay" id="addContractModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3><i class="fas fa-file-contract"></i> إضافة عقد جديد</h3>
                                <button class="close-btn" onclick="contractSystem.closeModal('addContractModal')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <form id="addContractForm">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>رقم العقد:</label>
                                            <input type="text" id="contractNumber" class="form-input" required>
                                        </div>
                                        <div class="form-group">
                                            <label>اسم العميل:</label>
                                            <input type="text" id="clientName" class="form-input" required>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>قيمة العقد:</label>
                                            <input type="number" id="contractAmount" class="form-input" required>
                                        </div>
                                        <div class="form-group">
                                            <label>حالة العقد:</label>
                                            <select id="contractStatus" class="form-input" required>
                                                <option value="active">نشط</option>
                                                <option value="pending">قيد الانتظار</option>
                                                <option value="completed">مكتمل</option>
                                                <option value="cancelled">ملغى</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>تاريخ البدء:</label>
                                            <input type="date" id="startDate" class="form-input" required>
                                        </div>
                                        <div class="form-group">
                                            <label>تاريخ الانتهاء:</label>
                                            <input type="date" id="endDate" class="form-input" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>وصف العقد:</label>
                                        <textarea id="contractDescription" class="form-input" rows="3"></textarea>
                                    </div>
                                    <button type="button" class="btn-primary" style="width: 100%; margin-top: 20px;" onclick="contractSystem.addContract()">
                                        <i class="fas fa-save"></i> حفظ العقد
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                this.showModal(modalHTML);
            }

            async addContract() {
                const contract = {
                    contractNumber: document.getElementById('contractNumber').value,
                    clientName: document.getElementById('clientName').value,
                    amount: document.getElementById('contractAmount').value,
                    status: document.getElementById('contractStatus').value,
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    description: document.getElementById('contractDescription').value,
                    createdAt: new Date().toISOString(),
                    createdBy: this.isMemberLogin ? this.currentUser.email : this.firebaseManager.currentUser.email
                };

                this.contracts.push(contract);
                await this.saveCurrentData();
                this.displayContracts();
                this.updateStats();
                this.closeModal('addContractModal');
                this.showNotification('تم إضافة العقد بنجاح');
            }

            editContract(index) {
                const contract = this.contracts[index];
                const modalHTML = `
                    <div class="modal-overlay" id="editContractModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3><i class="fas fa-edit"></i> تعديل العقد</h3>
                                <button class="close-btn" onclick="contractSystem.closeModal('editContractModal')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <form id="editContractForm">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>رقم العقد:</label>
                                            <input type="text" id="editContractNumber" class="form-input" value="${contract.contractNumber}" required>
                                        </div>
                                        <div class="form-group">
                                            <label>اسم العميل:</label>
                                            <input type="text" id="editClientName" class="form-input" value="${contract.clientName}" required>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>قيمة العقد:</label>
                                            <input type="number" id="editContractAmount" class="form-input" value="${contract.amount}" required>
                                        </div>
                                        <div class="form-group">
                                            <label>حالة العقد:</label>
                                            <select id="editContractStatus" class="form-input" required>
                                                <option value="active" ${contract.status === 'active' ? 'selected' : ''}>نشط</option>
                                                <option value="pending" ${contract.status === 'pending' ? 'selected' : ''}>قيد الانتظار</option>
                                                <option value="completed" ${contract.status === 'completed' ? 'selected' : ''}>مكتمل</option>
                                                <option value="cancelled" ${contract.status === 'cancelled' ? 'selected' : ''}>ملغى</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>تاريخ البدء:</label>
                                            <input type="date" id="editStartDate" class="form-input" value="${contract.startDate}" required>
                                        </div>
                                        <div class="form-group">
                                            <label>تاريخ الانتهاء:</label>
                                            <input type="date" id="editEndDate" class="form-input" value="${contract.endDate}" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>وصف العقد:</label>
                                        <textarea id="editContractDescription" class="form-input" rows="3">${contract.description || ''}</textarea>
                                    </div>
                                    <button type="button" class="btn-primary" style="width: 100%; margin-top: 20px;" onclick="contractSystem.updateContract(${index})">
                                        <i class="fas fa-save"></i> حفظ التعديلات
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                this.showModal(modalHTML);
            }

            async updateContract(index) {
                this.contracts[index] = {
                    ...this.contracts[index],
                    contractNumber: document.getElementById('editContractNumber').value,
                    clientName: document.getElementById('editClientName').value,
                    amount: document.getElementById('editContractAmount').value,
                    status: document.getElementById('editContractStatus').value,
                    startDate: document.getElementById('editStartDate').value,
                    endDate: document.getElementById('editEndDate').value,
                    description: document.getElementById('editContractDescription').value,
                    updatedAt: new Date().toISOString(),
                    updatedBy: this.isMemberLogin ? this.currentUser.email : this.firebaseManager.currentUser.email
                };

                await this.saveCurrentData();
                this.displayContracts();
                this.closeModal('editContractModal');
                this.showNotification('تم تعديل العقد بنجاح');
            }

            async deleteContract(index) {
                if (confirm('هل أنت متأكد من حذف هذا العقد؟')) {
                    this.contracts.splice(index, 1);
                    await this.saveCurrentData();
                    this.displayContracts();
                    this.updateStats();
                    this.showNotification('تم حذف العقد بنجاح');
                }
            }

            viewContract(index) {
                const contract = this.contracts[index];
                const modalHTML = `
                    <div class="modal-overlay" id="viewContractModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3><i class="fas fa-eye"></i> عرض العقد</h3>
                                <button class="close-btn" onclick="contractSystem.closeModal('viewContractModal')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div><strong>رقم العقد:</strong> ${contract.contractNumber}</div>
                                    <div><strong>اسم العميل:</strong> ${contract.clientName}</div>
                                    <div><strong>قيمة العقد:</strong> ${contract.amount} ر.ق</div>
                                    <div><strong>الحالة:</strong> <span class="status-badge status-${contract.status}">${this.getStatusText(contract.status)}</span></div>
                                    <div><strong>تاريخ البدء:</strong> ${contract.startDate}</div>
                                    <div><strong>تاريخ الانتهاء:</strong> ${contract.endDate}</div>
                                </div>
                                ${contract.description ? `<div style="margin-top: 15px;"><strong>الوصف:</strong><br>${contract.description}</div>` : ''}
                                <div style="margin-top: 15px; font-size: 12px; color: #666;">
                                    <div>تم الإنشاء بواسطة: ${contract.createdBy}</div>
                                    <div>تاريخ الإنشاء: ${new Date(contract.createdAt).toLocaleString('ar-SA')}</div>
                                    ${contract.updatedAt ? `<div>آخر تعديل: ${new Date(contract.updatedAt).toLocaleString('ar-SA')}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                this.showModal(modalHTML);
            }

            // === إدارة الفواتير ===
            displayInvoices() {
                const tableBody = document.getElementById('invoicesTableBody');
                tableBody.innerHTML = '';

                if (this.invoices.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                                <i class="fas fa-receipt" style="font-size: 48px; margin-bottom: 15px; display: block; color: #ccc;"></i>
                                لا توجد فواتير مضافة حتى الآن
                            </td>
                        </tr>
                    `;
                    return;
                }

                this.invoices.forEach((invoice, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${invoice.invoiceNumber}</td>
                        <td>${invoice.clientName}</td>
                        <td>${invoice.amount} ر.ق</td>
                        <td>${invoice.issueDate}</td>
                        <td>${invoice.dueDate}</td>
                        <td><span class="status-badge status-${invoice.status}">${this.getStatusText(invoice.status)}</span></td>
                        <td>
                            <button class="btn-sm btn-edit" onclick="contractSystem.editInvoice(${index})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-sm btn-delete" onclick="contractSystem.deleteInvoice(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn-sm btn-view" onclick="contractSystem.viewInvoice(${index})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            }

            showAddInvoiceModal() {
                const modalHTML = `
                    <div class="modal-overlay" id="addInvoiceModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3><i class="fas fa-receipt"></i> إضافة فاتورة جديدة</h3>
                                <button class="close-btn" onclick="contractSystem.closeModal('addInvoiceModal')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <form id="addInvoiceForm">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>رقم الفاتورة:</label>
                                            <input type="text" id="invoiceNumber" class="form-input" required>
                                        </div>
                                        <div class="form-group">
                                            <label>اسم العميل:</label>
                                            <input type="text" id="invoiceClientName" class="form-input" required>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>المبلغ:</label>
                                            <input type="number" id="invoiceAmount" class="form-input" required>
                                        </div>
                                        <div class="form-group">
                                            <label>حالة الفاتورة:</label>
                                            <select id="invoiceStatus" class="form-input" required>
                                                <option value="paid">مدفوعة</option>
                                                <option value="pending">قيد الانتظار</option>
                                                <option value="overdue">متأخرة</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>تاريخ الإصدار:</label>
                                            <input type="date" id="issueDate" class="form-input" required>
                                        </div>
                                        <div class="form-group">
                                            <label>تاريخ الاستحقاق:</label>
                                            <input type="date" id="dueDate" class="form-input" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>وصف الفاتورة:</label>
                                        <textarea id="invoiceDescription" class="form-input" rows="3"></textarea>
                                    </div>
                                    <button type="button" class="btn-primary" style="width: 100%; margin-top: 20px;" onclick="contractSystem.addInvoice()">
                                        <i class="fas fa-save"></i> حفظ الفاتورة
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                this.showModal(modalHTML);
            }

            async addInvoice() {
                const invoice = {
                    invoiceNumber: document.getElementById('invoiceNumber').value,
                    clientName: document.getElementById('invoiceClientName').value,
                    amount: document.getElementById('invoiceAmount').value,
                    status: document.getElementById('invoiceStatus').value,
                    issueDate: document.getElementById('issueDate').value,
                    dueDate: document.getElementById('dueDate').value,
                    description: document.getElementById('invoiceDescription').value,
                    createdAt: new Date().toISOString(),
                    createdBy: this.isMemberLogin ? this.currentUser.email : this.firebaseManager.currentUser.email
                };

                this.invoices.push(invoice);
                await this.saveCurrentData();
                this.displayInvoices();
                this.updateStats();
                this.closeModal('addInvoiceModal');
                this.showNotification('تم إضافة الفاتورة بنجاح');
            }

            editInvoice(index) {
                const invoice = this.invoices[index];
                const modalHTML = `
                    <div class="modal-overlay" id="editInvoiceModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3><i class="fas fa-edit"></i> تعديل الفاتورة</h3>
                                <button class="close-btn" onclick="contractSystem.closeModal('editInvoiceModal')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <form id="editInvoiceForm">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>رقم الفاتورة:</label>
                                            <input type="text" id="editInvoiceNumber" class="form-input" value="${invoice.invoiceNumber}" required>
                                        </div>
                                        <div class="form-group">
                                            <label>اسم العميل:</label>
                                            <input type="text" id="editInvoiceClientName" class="form-input" value="${invoice.clientName}" required>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>المبلغ:</label>
                                            <input type="number" id="editInvoiceAmount" class="form-input" value="${invoice.amount}" required>
                                        </div>
                                        <div class="form-group">
                                            <label>حالة الفاتورة:</label>
                                            <select id="editInvoiceStatus" class="form-input" required>
                                                <option value="paid" ${invoice.status === 'paid' ? 'selected' : ''}>مدفوعة</option>
                                                <option value="pending" ${invoice.status === 'pending' ? 'selected' : ''}>قيد الانتظار</option>
                                                <option value="overdue" ${invoice.status === 'overdue' ? 'selected' : ''}>متأخرة</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>تاريخ الإصدار:</label>
                                            <input type="date" id="editIssueDate" class="form-input" value="${invoice.issueDate}" required>
                                        </div>
                                        <div class="form-group">
                                            <label>تاريخ الاستحقاق:</label>
                                            <input type="date" id="editDueDate" class="form-input" value="${invoice.dueDate}" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>وصف الفاتورة:</label>
                                        <textarea id="editInvoiceDescription" class="form-input" rows="3">${invoice.description || ''}</textarea>
                                    </div>
                                    <button type="button" class="btn-primary" style="width: 100%; margin-top: 20px;" onclick="contractSystem.updateInvoice(${index})">
                                        <i class="fas fa-save"></i> حفظ التعديلات
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                this.showModal(modalHTML);
            }

            async updateInvoice(index) {
                this.invoices[index] = {
                    ...this.invoices[index],
                    invoiceNumber: document.getElementById('editInvoiceNumber').value,
                    clientName: document.getElementById('editInvoiceClientName').value,
                    amount: document.getElementById('editInvoiceAmount').value,
                    status: document.getElementById('editInvoiceStatus').value,
                    issueDate: document.getElementById('editIssueDate').value,
                    dueDate: document.getElementById('editDueDate').value,
                    description: document.getElementById('editInvoiceDescription').value,
                    updatedAt: new Date().toISOString(),
                    updatedBy: this.isMemberLogin ? this.currentUser.email : this.firebaseManager.currentUser.email
                };

                await this.saveCurrentData();
                this.displayInvoices();
                this.closeModal('editInvoiceModal');
                this.showNotification('تم تعديل الفاتورة بنجاح');
            }

            async deleteInvoice(index) {
                if (confirm('هل أنت متأكد من حذف هذه الفاتورة؟')) {
                    this.invoices.splice(index, 1);
                    await this.saveCurrentData();
                    this.displayInvoices();
                    this.updateStats();
                    this.showNotification('تم حذف الفاتورة بنجاح');
                }
            }

            viewInvoice(index) {
                const invoice = this.invoices[index];
                const modalHTML = `
                    <div class="modal-overlay" id="viewInvoiceModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3><i class="fas fa-eye"></i> عرض الفاتورة</h3>
                                <button class="close-btn" onclick="contractSystem.closeModal('viewInvoiceModal')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div><strong>رقم الفاتورة:</strong> ${invoice.invoiceNumber}</div>
                                    <div><strong>اسم العميل:</strong> ${invoice.clientName}</div>
                                    <div><strong>المبلغ:</strong> ${invoice.amount} ر.ق</div>
                                    <div><strong>الحالة:</strong> <span class="status-badge status-${invoice.status}">${this.getStatusText(invoice.status)}</span></div>
                                    <div><strong>تاريخ الإصدار:</strong> ${invoice.issueDate}</div>
                                    <div><strong>تاريخ الاستحقاق:</strong> ${invoice.dueDate}</div>
                                </div>
                                ${invoice.description ? `<div style="margin-top: 15px;"><strong>الوصف:</strong><br>${invoice.description}</div>` : ''}
                                <div style="margin-top: 15px; font-size: 12px; color: #666;">
                                    <div>تم الإنشاء بواسطة: ${invoice.createdBy}</div>
                                    <div>تاريخ الإنشاء: ${new Date(invoice.createdAt).toLocaleString('ar-SA')}</div>
                                    ${invoice.updatedAt ? `<div>آخر تعديل: ${new Date(invoice.updatedAt).toLocaleString('ar-SA')}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                this.showModal(modalHTML);
            }

            // === إدارة الأعضاء ===
            displayMembers() {
                const tableBody = document.getElementById('usersTableBody');
                tableBody.innerHTML = '';

                if (this.members.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                                <i class="fas fa-users" style="font-size: 48px; margin-bottom: 15px; display: block; color: #ccc;"></i>
                                لا توجد أعضاء مضافة حتى الآن
                            </td>
                        </tr>
                    `;
                    return;
                }

                this.members.forEach((member, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${member.fullName}</td>
                        <td>${member.email}</td>
                        <td>عضو</td>
                        <td>${member.joinDate}</td>
                        <td><span class="status-badge status-active">نشط</span></td>
                        <td>
                            <button class="btn-sm btn-edit" onclick="contractSystem.editMemberPermissions('${member.email}')">
                                <i class="fas fa-shield-alt"></i> الصلاحيات
                            </button>
                            <button class="btn-sm btn-delete" onclick="contractSystem.deleteMember(${index})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            }

            showAddMemberModal() {
                const modalHTML = `
                    <div class="modal-overlay" id="addMemberModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3><i class="fas fa-user-plus"></i> إضافة عضو جديد</h3>
                                <button class="close-btn" onclick="contractSystem.closeModal('addMemberModal')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <form id="addMemberForm">
                                    <div class="form-group">
                                        <label>الاسم الكامل:</label>
                                        <input type="text" id="memberFullName" class="form-input" required>
                                    </div>
                                    <div class="form-group">
                                        <label>البريد الإلكتروني:</label>
                                        <input type="email" id="memberEmailAdd" class="form-input" required>
                                    </div>
                                    <div class="form-group">
                                        <label>كلمة المرور:</label>
                                        <input type="password" id="memberPasswordAdd" class="form-input" required minlength="6">
                                    </div>
                                    <div class="form-group">
                                        <label>تأكيد كلمة المرور:</label>
                                        <input type="password" id="memberConfirmPassword" class="form-input" required minlength="6">
                                    </div>
                                    <button type="button" class="btn-primary" style="width: 100%; margin-top: 20px;" onclick="contractSystem.addMember()">
                                        <i class="fas fa-user-plus"></i> إضافة العضو
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                this.showModal(modalHTML);
            }

            async addMember() {
                const fullName = document.getElementById('memberFullName').value;
                const email = document.getElementById('memberEmailAdd').value;
                const password = document.getElementById('memberPasswordAdd').value;
                const confirmPassword = document.getElementById('memberConfirmPassword').value;
                
                if (!fullName || !email || !password || !confirmPassword) {
                    this.showNotification('يرجى ملء جميع الحقول', 'error');
                    return;
                }
                
                if (password !== confirmPassword) {
                    this.showNotification('كلمتا المرور غير متطابقتين!', 'error');
                    return;
                }

                // التحقق من عدم وجود عضو بنفس البريد الإلكتروني
                const existingMember = this.members.find(m => m.email === email);
                if (existingMember) {
                    this.showNotification('هذا البريد الإلكتروني مسجل بالفعل!', 'error');
                    return;
                }

                const memberData = {
                    fullName: fullName,
                    email: email,
                    password: password,
                    joinDate: new Date().toISOString().split('T')[0],
                    createdBy: this.firebaseManager.currentUser.email,
                    isMember: true
                };

                // إضافة العضو إلى القائمة
                this.members.push(memberData);
                
                // إنشاء صلاحيات افتراضية للعضو الجديد
                this.permissions[memberData.email] = this.getDefaultMemberPermissions();
                
                await this.saveCurrentData();
                this.displayMembers();
                this.updateStats();
                this.closeModal('addMemberModal');
                this.showNotification('تم إضافة العضو بنجاح');
            }

            async deleteMember(index) {
                if (confirm('هل أنت متأكد من حذف هذا العضو؟')) {
                    const memberEmail = this.members[index].email;
                    
                    // حذف الصلاحيات المرتبطة بالعضو
                    delete this.permissions[memberEmail];
                    
                    this.members.splice(index, 1);
                    await this.saveCurrentData();
                    this.displayMembers();
                    this.updateStats();
                    this.showNotification('تم حذف العضو بنجاح');
                }
            }

            editMemberPermissions(memberEmail) {
                this.showSection('settings');
            }

            // === إدارة الصلاحيات ===
            displayPermissions() {
                const permissionsList = document.getElementById('permissionsList');
                permissionsList.innerHTML = '';

                if (this.members.length === 0) {
                    permissionsList.innerHTML = '<p style="text-align: center; color: #666;">لا يوجد أعضاء لعرض صلاحياتهم</p>';
                    return;
                }

                this.members.forEach(member => {
                    const memberPermissions = this.permissions[member.email] || this.getDefaultMemberPermissions();
                    
                    const permissionHTML = `
                        <div class="permission-item">
                            <div class="permission-header">
                                <div class="permission-title">${member.fullName}</div>
                                <div class="user-email">${member.email}</div>
                            </div>
                            <div class="permission-users">
                                <div class="user-permission">
                                    <span>منع دخول صفحة العقود</span>
                                    <input type="checkbox" ${memberPermissions.denyContracts ? 'checked' : ''} 
                                        onchange="contractSystem.updateMemberPermission('${member.email}', 'denyContracts', this.checked)">
                                </div>
                                <div class="user-permission">
                                    <span>منع دخول صفحة الفواتير</span>
                                    <input type="checkbox" ${memberPermissions.denyInvoices ? 'checked' : ''} 
                                        onchange="contractSystem.updateMemberPermission('${member.email}', 'denyInvoices', this.checked)">
                                </div>
                                <div class="user-permission">
                                    <span>منع تعديل العقود</span>
                                    <input type="checkbox" ${memberPermissions.denyEditContract ? 'checked' : ''} 
                                        onchange="contractSystem.updateMemberPermission('${member.email}', 'denyEditContract', this.checked)">
                                </div>
                                <div class="user-permission">
                                    <span>منع تعديل الفواتير</span>
                                    <input type="checkbox" ${memberPermissions.denyEditInvoice ? 'checked' : ''} 
                                        onchange="contractSystem.updateMemberPermission('${member.email}', 'denyEditInvoice', this.checked)">
                                </div>
                                <div class="user-permission">
                                    <span>منع دخول الإعدادات</span>
                                    <input type="checkbox" ${memberPermissions.denySettings ? 'checked' : ''} 
                                        onchange="contractSystem.updateMemberPermission('${member.email}', 'denySettings', this.checked)">
                                </div>
                            </div>
                        </div>
                    `;
                    permissionsList.innerHTML += permissionHTML;
                });

                if (permissionsList.innerHTML === '') {
                    permissionsList.innerHTML = '<p style="text-align: center; color: #666;">لا يوجد أعضاء لعرض صلاحياتهم</p>';
                }
            }

            async updateMemberPermission(memberEmail, permission, value) {
                if (!this.permissions[memberEmail]) {
                    this.permissions[memberEmail] = this.getDefaultMemberPermissions();
                }
                
                this.permissions[memberEmail][permission] = value;
                await this.saveCurrentData();
                this.showNotification('تم تحديث الصلاحيات بنجاح');
            }

            // === دوال مساعدة ===
            getDefaultMemberPermissions() {
                return {
                    denyContracts: false,
                    denyInvoices: false,
                    denyEditContract: false,
                    denyEditInvoice: false,
                    denySettings: true,
                    denyAddContract: false,
                    denyAddInvoice: false
                };
            }

            getStatusText(status) {
                const statusMap = {
                    'active': 'نشط',
                    'pending': 'قيد الانتظار',
                    'completed': 'مكتمل',
                    'cancelled': 'ملغى',
                    'paid': 'مدفوعة',
                    'overdue': 'متأخرة'
                };
                return statusMap[status] || status;
            }

            showModal(html) {
                this.closeAllModals();
                document.getElementById('modalContainer').innerHTML = html;
            }

            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) modal.remove();
            }

            closeAllModals() {
                document.getElementById('modalContainer').innerHTML = '';
            }

            showNotification(message, type = 'success') {
                // إزالة الإشعارات القديمة
                document.querySelectorAll('.notification').forEach(notification => notification.remove());
                
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <div class="notification-content">
                        <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation' : 'info'}-circle"></i>
                        <span>${message}</span>
                    </div>
                    <button class="notification-close" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                document.getElementById('notificationContainer').appendChild(notification);
                
                // إزالة الإشعار تلقائياً بعد 5 ثواني
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }

            async logout() {
                if (this.isMemberLogin) {
                    // تسجيل خروج العضو
                    this.currentUser = null;
                    this.currentMember = null;
                    this.isMemberLogin = false;
                } else {
                    // تسجيل خروج المدير
                    await this.firebaseManager.logout();
                }
                
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('loginPage').style.display = 'flex';
                
                // مسح الحقول
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
                
                this.showNotification('تم تسجيل الخروج بنجاح');
            }

            checkAuthStatus() {
                console.log('🔍 Checking auth status...');
            }

            exportData() {
                this.showNotification('جاري تصدير البيانات...', 'info');
            }
        }

        // مدير Firebase المحسن
        class FirebaseManager {
            constructor() {
                this.auth = null;
                this.db = null;
                this.currentUser = null;
                this.isInitialized = false;
            }

            async init() {
                try {
                    const firebaseConfig = {
                        apiKey: "AIzaSyBUMgt1C6gdDrtgpBcMkyHBZFDeHiDd1HI",
                        authDomain: "mohanad-93df3.firebaseapp.com",
                        projectId: "mohanad-93df3",
                        storageBucket: "mohanad-93df3.appspot.com",
                        messagingSenderId: "1057899918391",
                        appId: "1:1057899918391:web:a1b2c3d4e5f6g7h8i9j0"
                    };

                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    
                    this.auth = firebase.auth();
                    this.db = firebase.firestore();
                    
                    await new Promise((resolve, reject) => {
                        const unsubscribe = this.auth.onAuthStateChanged((user) => {
                            this.currentUser = user;
                            this.isInitialized = true;
                            unsubscribe();
                            resolve(user);
                        }, reject);
                    });
                    
                    console.log('✅ Firebase Manager initialized successfully');
                    return true;
                } catch (error) {
                    console.error('❌ Firebase Manager init error:', error);
                    this.isInitialized = false;
                    throw error;
                }
            }

            async login(email, password) {
                try {
                    if (!this.isInitialized) {
                        await this.init();
                    }

                    const userCredential = await this.auth.signInWithEmailAndPassword(email, password);
                    this.currentUser = userCredential.user;
                    
                    console.log('✅ Login successful:', this.currentUser.email);
                    return { 
                        success: true, 
                        user: this.currentUser,
                        userId: this.currentUser.uid 
                    };
                } catch (error) {
                    let errorMessage = 'فشل في تسجيل الدخول';
                    switch (error.code) {
                        case 'auth/user-not-found': errorMessage = 'المستخدم غير موجود'; break;
                        case 'auth/wrong-password': errorMessage = 'كلمة المرور غير صحيحة'; break;
                        case 'auth/invalid-email': errorMessage = 'البريد الإلكتروني غير صالح'; break;
                        case 'auth/too-many-requests': errorMessage = 'محاولات تسجيل دخول كثيرة، حاول لاحقاً'; break;
                        default: errorMessage = error.message;
                    }
                    console.error('❌ Login error:', error);
                    return { success: false, error: errorMessage };
                }
            }

            async logout() {
                try {
                    await this.auth.signOut();
                    this.currentUser = null;
                    this.isInitialized = false;
                    
                    // مسح التخزين المحلي
                    localStorage.removeItem('propertyUser');
                    localStorage.removeItem('userData');
                    
                    console.log('✅ Logout successful');
                    return { success: true };
                } catch (error) {
                    console.error('❌ Logout error:', error);
                    return { success: false, error: error.message };
                }
            }

            async saveUserData(userData) {
                try {
                    if (!this.currentUser) {
                        throw new Error('No user logged in');
                    }

                    if (!this.isInitialized) {
                        await this.init();
                    }

                    const userId = this.currentUser.uid;
                    
                    userData._metadata = userData._metadata || {};
                    userData._metadata.lastUpdated = new Date().toISOString();
                    userData._metadata.userId = userId;
                    userData._metadata.userEmail = this.currentUser.email;
                    
                    await this.db.collection('users').doc(userId).set(userData, { merge: true });
                    
                    console.log('💾 Data saved to Firebase successfully');
                    return { success: true };
                } catch (error) {
                    console.error('❌ Save data error:', error);
                    return { success: false, error: error.message };
                }
            }

            async getUserData() {
                try {
                    if (!this.currentUser) {
                        throw new Error('No user logged in');
                    }

                    if (!this.isInitialized) {
                        await this.init();
                    }

                    const userId = this.currentUser.uid;
                    const docRef = this.db.collection('users').doc(userId);
                    const doc = await docRef.get();
                    
                    if (doc.exists) {
                        const data = doc.data();
                        console.log('📥 Data loaded from Firebase');
                        return { 
                            success: true, 
                            data: data,
                            source: 'firebase'
                        };
                    } else {
                        console.log('📝 No data found, creating default data');
                        const defaultData = this.getDefaultUserData();
                        await this.saveUserData(defaultData);
                        return { 
                            success: true, 
                            data: defaultData,
                            source: 'default'
                        };
                    }
                } catch (error) {
                    console.error('❌ Get user data error:', error);
                    return { success: false, error: error.message };
                }
            }

            // دالة جديدة لجلب بيانات الحساب الرئيسي (للاستخدام من قبل الأعضاء)
            async getMainAccountData() {
                try {
                    if (!this.isInitialized) {
                        await this.init();
                    }

                    // نفترض أن هناك مستند رئيسي واحد يخزن بيانات النظام
                    const mainDocRef = this.db.collection('system').doc('main_account');
                    const doc = await mainDocRef.get();
                    
                    if (doc.exists) {
                        const data = doc.data();
                        console.log('📥 Main account data loaded from Firebase');
                        return { 
                            success: true, 
                            data: data,
                            source: 'firebase'
                        };
                    } else {
                        console.log('📝 No main account data found');
                        return { success: false, error: 'No main account data found' };
                    }
                } catch (error) {
                    console.error('❌ Get main account data error:', error);
                    return { success: false, error: error.message };
                }
            }

            getDefaultUserData() {
                return {
                    userProfile: {
                        name: '',
                        email: this.currentUser?.email || '',
                        lastLogin: new Date().toISOString(),
                        createdDate: new Date().toISOString()
                    },
                    contracts: [],
                    invoices: [],
                    members: [],
                    permissions: {},
                    _metadata: {
                        created: new Date().toISOString(),
                        lastUpdated: new Date().toISOString(),
                        userId: this.currentUser?.uid || '',
                        userEmail: this.currentUser?.email || ''
                    }
                };
            }
        }

        // تهيئة النظام عند تحميل الصفحة
        let contractSystem;
        document.addEventListener('DOMContentLoaded', function() {
            contractSystem = new ContractManagementSystem();
            console.log('🚀 نظام إدارة العقود والفواتير جاهز للاستخدام!');
        });
    </script>
</body>
</html>
